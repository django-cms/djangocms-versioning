name: Frontend E2E Tests

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Chromium browser
      run: npx playwright install --with-deps chromium

    - name: Run linter
      run: npx gulp lint

    - name: Run E2E tests with coverage
      run: |
        npm run e2e
        npm run e2e:coverage:report


    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-e2e
        path: coverage-e2e/
        retention-days: 30

    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coveragePath = 'coverage-e2e/lcov-report/index.html';

          if (!fs.existsSync(coveragePath)) {
            console.log('Coverage report not found');
            return;
          }

          // Read the summary from the test output
          const summary = `## Frontend E2E Test Coverage

          Coverage reports have been generated and uploaded as artifacts.

          Download the artifacts from this workflow run to view the full HTML coverage report.
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
